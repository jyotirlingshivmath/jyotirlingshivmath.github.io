<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>School Fees Receipt</title>

<style>
body{font-family:Arial;background:#f5f5f5;}
.container{width:800px;margin:20px auto;background:#fff;padding:20px;border:1px solid #000;}
h2,h3{text-align:center;margin:5px;}
.row{display:flex;justify-content:space-between;margin-bottom:10px;}
label{width:140px;font-weight:bold;}
input{width:200px;padding:5px;}
button{padding:8px 15px;margin-top:10px;cursor:pointer;}
@media print{
  button{display:none;}
  body{background:#fff;}
}
</style>
</head>

<body>
<div class="container">

<h2>JYOTIRLING SHIVMATH VADIC VIDYALAYA</h2>
<h3>FEES RECEIPT</h3>

<!-- SEARCH -->
<div class="row">
  <label>Admission No</label>
  <input type="text" id="searchAdm">
</div>

<div class="row">
  <label>Student Name</label>
  <input type="text" id="searchName">
</div>

<button id="searchBtn">Search</button>

<hr>

<!-- STUDENT DETAILS -->
<div class="row">
  <label>Admission No</label>
  <input id="admno" readonly>
</div>

<div class="row">
  <label>Name</label>
  <input id="name" readonly>
</div>

<div class="row">
  <label>Class</label>
  <input id="class" readonly>
</div>

<div class="row">
  <label>Father Name</label>
  <input id="father" readonly>
</div>

<hr>

<!-- FEES DETAILS -->
<div class="row">
  <label>Receipt No</label>
  <input id="receipt">
</div>

<div class="row">
  <label>Month</label>
  <input id="month">
</div>

<div class="row">
  <label>Total Fees</label>
  <input id="total">
</div>

<div class="row">
  <label>Paid Amount</label>
  <input id="paid">
</div>

<div class="row">
  <label>Remaining</label>
  <input id="remain" readonly>
</div>

<button id="saveBtn">Save Fees</button>
<button onclick="window.print()">Print Receipt</button>

</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzwm6W71050QAPQj9UTZnPfDi6xlXtFnrpKkxkR2vQW6fEVf1x-Vcd5JGpoHMChJECa/exec";

// SEARCH STUDENT
function searchStudent() {
  const adm = document.getElementById("searchAdm").value.trim();
  const nameVal = document.getElementById("searchName").value.trim();

  if (!adm && !nameVal) {
    alert("Enter Admission No or Student Name to search");
    return;
  }

  fetch(`${WEB_APP_URL}?admno=${encodeURIComponent(adm)}&student_name=${encodeURIComponent(nameVal)}`)
    .then(res => res.json())
    .then(d => {
      if (!d.success || d.data.length === 0) {
        alert("Student not found");
        document.getElementById("admno").value = "";
        document.getElementById("name").value = "";
        document.getElementById("class").value = "";
        document.getElementById("father").value = "";
        return;
      }
      const student = d.data[0];
      document.getElementById("admno").value = student.admno || "";
      document.getElementById("name").value = student.student_name || "";
      document.getElementById("class").value = student.class_name || "";
      document.getElementById("father").value = student.father_name || "";
    })
    .catch(err => {
      console.error(err);
      alert("Error fetching student data");
    });
}

// CALCULATE REMAINING
function calcRemain() {
  const t = +document.getElementById("total").value || 0;
  const p = +document.getElementById("paid").value || 0;
  document.getElementById("remain").value = t - p;
}

// SAVE FEES USING FETCH
function saveFees() {
  const admVal = document.getElementById("admno").value;
  if (!admVal) {
    alert("Please select a student first");
    return;
  }

  const data = {
    receipt: document.getElementById("receipt").value || new Date().getTime(),
    admno: admVal,
    name: document.getElementById("name").value,
    month: document.getElementById("month").value,
    total: document.getElementById("total").value,
    paid: document.getElementById("paid").value,
    remain: document.getElementById("remain").value
  };

  fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify(data),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(resp => {
    if(resp.success){
      alert("Fees saved successfully");
      document.getElementById("receipt").value = "";
      document.getElementById("month").value = "";
      document.getElementById("total").value = "";
      document.getElementById("paid").value = "";
      document.getElementById("remain").value = "";
    } else {
      alert("Error saving fees: " + (resp.error || ""));
    }
  })
  .catch(err => {
    console.error(err);
    alert("Error saving fees");
  });
}

// Event listeners
document.getElementById("searchBtn").addEventListener("click", searchStudent);
document.getElementById("total").addEventListener("input", calcRemain);
document.getElementById("paid").addEventListener("input", calcRemain);
document.getElementById("saveBtn").addEventListener("click", saveFees);
</script>

</body>
</html>
