<script>
document.addEventListener("DOMContentLoaded", function () {

  const WEB_APP_URL =
  "https://script.google.com/macros/s/AKfycbyvpfXNi_HCaNQHSSP72KrEJXkpiZKAkmxw_su1nYm42v4Co2lLW2qyGV-GjA6MVJ9D/exec";

  const form = document.getElementById("admissionForm");
  const admno = document.getElementById("admno");
  const admdate = document.getElementById("admdate");
  const photo = document.getElementById("photo");
  const photoPreview = document.getElementById("photoPreview");

  let lastAdm = parseInt(localStorage.getItem("lastAdm")) || 3000;
  admno.value = ++lastAdm;
  localStorage.setItem("lastAdm", lastAdm);

  admdate.value = new Date().toISOString().slice(0,10);

  let photoData = "";
  photo.addEventListener("change", e => {
    const r = new FileReader();
    r.onload = () => {
      photoPreview.src = r.result;
      photoData = r.result;
    };
    r.readAsDataURL(e.target.files[0]);
  });

  form.addEventListener("submit", function(e){
    e.preventDefault();

    const data = {
      timestamp: new Date().toISOString(),
      admno: admno.value,
      student_name: document.getElementById("name").value,
      gender: document.getElementById("gender").value,
      dob: document.getElementById("dob").value,
      category: document.getElementById("category").value,
      blood_group: document.getElementById("blood").value,
      father_name: document.getElementById("father").value,
      father_occ: document.getElementById("fatherocc").value,
      mother_name: document.getElementById("mother").value,
      mother_occ: document.getElementById("motherocc").value,
      mobile: document.getElementById("contact").value,
      email: document.getElementById("email").value,
      address: document.getElementById("address").value,
      class_name: document.getElementById("studentClass").value,
      prev_school: document.getElementById("prevSchool").value,
      photo: photoData
    };

    fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {
      if(res.success){
        alert("✅ Admission Saved & Sheet Updated");
      } else {
        alert("❌ Sheet Error");
      }
    })
    .catch(err => {
      console.error(err);
      alert("❌ Script Error");
    });

    form.reset();
    photoPreview.src = "";
    admno.value = ++lastAdm;
    localStorage.setItem("lastAdm", lastAdm);
  });

});
</script>
